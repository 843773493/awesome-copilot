# MOS Technology 6522 多功能接口适配器（VIA）

## 1. 概述

**MOS Technology 6522 VIA** 是一款通用输入输出控制器，用于将 6502 系列微处理器与外部外设接口连接。自 20 世纪 70 年代中期推出以来，它提供了并行 I/O 接口、定时器、移位寄存器支持以及中断处理功能。6522 被广泛应用于 Commodore PET、VIC-20、Apple II、BBC Micro 以及许多基于 6502 的嵌入式设计系统中。

---

## 2. 一般特性

| 特性         | 描述                          |
| ------------ | ----------------------------- |
| 数据宽度     | 8 位                          |
| 寻址方式     | 内存映射输入输出              |
| 寄存器数量   | 16 个（4 位寄存器选择）       |
| I/O 接口     | 两个 8 位接口（端口 A，端口 B） |
| 定时器       | 两个 16 位定时器               |
| 移位寄存器   | 8 位串行 I/O                  |
| 中断         | 可屏蔽中断，多源               |
| 时钟         | 系统时钟（φ2）                 |

---

## 3. 引脚功能（逻辑）

### 3.1 端口 A（PA0-PA7）

* 8 位双向并行 I/O
* 通过 CA1 / CA2 支持握手协议

### 3.2 端口 B（PB0-PB7）

* 8 位双向并行 I/O
* 通过 CB1 / CB2 支持握手协议 / 脉冲 / 中断引脚
* PB6 和 PB7 可能由定时器 1 控制

### 3.3 控制引脚

| 引脚       | 描述                           |
| --------- | ----------------------------- |
| CA1 / CB1 | 可中断控制输入                 |
| CA2 / CB2 | 握手 / 脉冲 / 中断引脚          |
| IRQ       | 中断请求输出（低电平有效）      |
| RESET     | 复位输入                       |

---

## 4. 寄存器映射

寄存器通过 4 根地址线（RS0-RS3）选择，基地址由系统定义。

| 偏移量 | 寄存器  | 描述                          |
| -----: | ------- | ----------------------------- |
|     $0 | ORB     | 输出寄存器 B                   |
|     $1 | ORA / IRB | 输出寄存器 A / 输入寄存器 B     |
|     $2 | DDRB    | 数据方向寄存器 B                |
|     $3 | DDRA    | 数据方向寄存器 A                |
|     $4 | T1C-L   | 定时器 1 计数器低字节            |
|     $5 | T1C-H   | 定时器 1 计数器高字节            |
|     $6 | T1L-L   | 定时器 1 锁存低字节              |
|     $7 | T1L-H   | 定时器 1 锁存高字节              |
|     $8 | T2C-L   | 定时器 2 计数器低字节            |
|     $9 | T2C-H   | 定时器 2 计数器高字节            |
|     $A | SR       | 移位寄存器                      |
|     $B | ACR      | 辅助控制寄存器                   |
|     $C | PCR      | 外设控制寄存器                   |
|     $D | IFR      | 中断标志寄存器                   |
|     $E | IER      | 中断使能寄存器                   |
|     $F | ORA / IRA | 输出寄存器 A / 输入寄存器 A       |

---

## 5. 数据方向寄存器（DDRA / DDRB）

每个位控制其对应端口引脚的方向：

* `0` = 输入
* `1` = 输出

```text
DDRB bit = 1  PBx 是输出
DDRB bit = 0  PBx 是输入
```

---

## 6. 定时器

### 6.1 定时器 1（T1）

* 16 位向下计数器
* 可以在单次触发模式或自由运行模式下工作
* 在超时时可以切换 PB7
* 生成中断

### 6.2 定时器 2（T2）

* 16 位向下计数器
* 支持在 PB6 上进行脉冲计数
* 仅支持单次触发操作

---

## 7. 移位寄存器（SR）

* 8 位移位寄存器
* 可以进行数据的输入或输出
* 时钟源可通过 ACR 选择
* 常用于串行通信或键盘扫描

---

## 8. 控制寄存器

### 8.1 辅助控制寄存器（ACR）

| 位 | 功能                           |
| --: | ----------------------------- |
|   7 | 定时器 1 控制（PB7 输出）       |
|   6 | 定时器 1 模式（自由运行 / 单次触发） |
|   5 | 定时器 2 控制                   |
|   4 | 移位寄存器模式                  |
|   3 | 移位寄存器时钟源                |
|   2 | 端口 B 锁存                    |
|   1 | 端口 A 锁存                    |
|   0 | 未使用                        |

### 8.2 外设控制寄存器（PCR）

控制 CA1、CA2、CB1、CB2 的行为：

* 输入/输出模式
* 活跃边选择
* 脉冲或握手模式

---

## 9. 中断系统

### 9.1 中断标志寄存器（IFR）

| 位 | 中断源                         |
| --: | ----------------------------- |
|   7 | IRQ 状态（任何使能的中断）      |
|   6 | 定时器 1                       |
|   5 | 定时器 2                       |
|   4 | CB1                            |
|   3 | CB2                            |
|   2 | 移位寄存器                     |
|   1 | CA1                            |
|   0 | CA2                            |

### 9.2 中断使能寄存器（IER）

* 位 7 决定设置/清除模式：

  * `1` = 设置位
  * `0` = 清除位

```text
写入 $80 | 掩码  使能中断
写入 $00 | 掩码  禁用中断
```

---

## 10. 复位行为

复位时：

* 所有 DDR 位被清除（端口默认为输入）
* 定时器停止
* 移位寄存器禁用
* 中断禁用

---

## 11. 时序说明

* VIA 寄存器通过 φ2 同步访问
* 定时器计数器每 φ2 周期递减一次
* 读取/写入寄存器时某些操作会产生副作用

---

## 12. 常见应用场景

* 键盘和操纵杆接口
* 并行打印机接口
* 定时器和事件计数
* 简单的串行通信
* 通用通用输入输出（GPIO）扩展

---

## 13. 变种及相关芯片

| 芯片 | 说明                         |
| ----- | ----------------------------- |
| 6522 | 原始 NMOS VIA                |
| 65C22 | CMOS VIA，速度更快，功耗更低 |
| 6520 | 更早的 PIA（更简单）          |

---

## 14. 参考资料

* <https://en.wikipedia.org/wiki/MOS_Technology_6522>
* <https://grokipedia.com/page/MOS_Technology_6522>
