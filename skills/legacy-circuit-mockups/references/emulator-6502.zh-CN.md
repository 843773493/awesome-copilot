# 6502 CPU 仿真规范

适用于**MOS Technology 6502 CPU系列仿真的技术Markdown规范**，适合用于软件仿真器、教育工具、测试框架和复古计算项目。

---

## 1. 适用范围

本规范描述了仿真的功能需求：

* MOS 6502
* WDC 65C02（注明之处）

不适用范围：

* 精确的周期模拟行为
* 物理总线竞争
* 未记录的硅片缺陷（除非明确实现）

---

## 2. CPU概述

### 核心特性

| 特性         | 值           |
|--------------|--------------|
| 数据宽度     | 8位          |
| 地址宽度     | 16位         |
| 地址空间     | 64 KB        |
| 字节序       | 小端序       |
| 时钟         | 单相时钟     |

---

## 3. 寄存器

| 寄存器 | 大小 | 描述                   |
|--------|------|------------------------|
| A      | 8位  | 累加器                 |
| X      | 8位  | 索引寄存器              |
| Y      | 8位  | 索引寄存器              |
| SP     | 8位  | 堆栈指针（页面 $01xx） |
| PC     | 16位 | 程序计数器             |
| P      | 8位  | 处理器状态标志          |

### 状态标志（P）

| 位 | 名称 | 含义                     |
|----|------|--------------------------|
| 7  | N    | 负数标志                 |
| 6  | V    | 溢出标志                 |
| 5  | -    | 未使用（当被压栈时始终为1） |
| 4  | B    | 断点标志                 |
| 3  | D    | 十进制标志               |
| 2  | I    | 中断禁用标志             |
| 1  | Z    | 零标志                  |
| 0  | C    | 进位标志                |

---

## 4. 内存模型

### 地址寻址

* 16位地址总线 (`$0000-$FFFF`)
* 字节寻址

### 必需的仿真接口

```text
read(address)  -> byte
write(address, byte)
```

### 堆栈行为

* 堆栈基地址: `$0100`
* 压栈: `写入 $0100 + SP 地址的值；SP 减1`
* 弹栈: `SP 加1；value = 读取 $0100 + SP`

---

## 5. 复位与中断处理

### 复位序列

1. 设置 `I = 1`
2. 设置 `SP = $FD`
3. 清除 `D`
4. 从 `$FFFC-$FFFD` 加载 `PC`

### 中断向量

| 中断类型 | 向量地址     |
|----------|--------------|
| NMI      | `$FFFA-$FFFB` |
| RESET    | `$FFFC-$FFFD` |
| IRQ/BRK  | `$FFFE-$FFFF` |

---

## 6. 指令取指-译码-执行周期

### 执行循环（概念性）

```text
opcode = read(PC++)
译码 opcode
获取操作数
执行指令
更新标志
增加周期数
```

---

## 7. 地址寻址模式

| 模式         | 示例         | 说明                   |
|--------------|--------------|------------------------|
| 立即数       | `LDA #$10`   | 常量                   |
| 零页         | `LDA $20`    | 在 $00FF 处环绕        |
| 绝对地址      | `LDA $2000`  | 完整地址               |
| 索引寻址      | `LDA $2000,X` | 可选页跨惩罚           |
| 间接寻址      | `JMP ($FFFC)` | 页面环绕错误           |
| 索引间接寻址  | `LDA ($20,X)` | 零页索引               |
| 间接索引寻址  | `LDA ($20),Y` | 零页指针               |

---

## 8. 指令集要求

### 分类

* 加载/存储
* 算术运算（ADC、SBC）
* 逻辑运算（AND、ORA、EOR）
* 移位与循环
* 跳转
* 堆栈操作
* 系统控制

### 十进制模式（NMOS 6502）

* 适用于 `ADC` 和 `SBC`
* 当 `D = 1` 时使用二进制编码十进制（BCD）运算

---

## 9. 标志行为规则

| 指令类型 | 影响的标志 |
|----------|------------|
| 加载操作 | N、Z       |
| ADC/SBC  | N、V、Z、C |
| CMP/CPX/CPY | N、Z、C |
| INC/DEC  | N、Z       |
| 移位操作 | N、Z、C    |

---

## 10. 周期计数

### 周期准确性等级

| 等级         | 描述               |
|--------------|--------------------|
| 功能正确性   | 仅保证正确结果     |
| 指令准确     | 固定周期数         |
| 精确周期     | 跨页惩罚           |

### 页面边界惩罚

* 跳转执行: +1 周期
* 跨页跳转: +2 周期
* 索引加载跨页: +1 周期

---

## 11. 已知硬件特性（NMOS 6502）

| 特性         | 描述                     |
|--------------|--------------------------|
| JMP间接跳转错误 | 页面边界处高位字节环绕    |
| BRK设置B标志 | 仅在被压栈时设置          |
| 未使用的标志位 | 始终读取为1              |

---

## 12. 非法/未记录的指令码（可选）

* 许多指令码执行复合操作
* 行为因芯片版本而异
* 应该禁用或明确启用

---

## 13. 时序与时钟

* 每个指令执行需要多个时钟周期
* 仿真器可能按主机时钟周期执行指令
* 需要周期计数器用于I/O时序

---

## 14. 与外设的集成

### 内存映射I/O

```text
如果地址在I/O范围内:
    转交给设备
```

示例：

* 6522 VIA
* UART
* 视频硬件

---

## 15. 测试与验证

### 推荐测试ROM

* Klaus Dormann 6502功能测试
* 中断和十进制模式测试

### 验证检查清单

* 所有指令正确执行
* 标志与参考行为一致
* 中断向量处理正确
* 堆栈操作无误

---

## 16. 参考链接

* [https://www.masswerk.at/6502/6502_instruction_set.html](https://www.masswerk.at/6502/6502_instruction_set.html)
* [https://www.nesdev.org/wiki/6502](https://www.nesdev.org/wiki/6502)
* [https://github.com/Klaus2m5/6502_65C02_functional_tests](https://github.com/Klaus2m5/6502_65C02_functional_tests)
* [https://en.wikipedia.org/wiki/MOS_Technology_6502](https://en.wikipedia.org/wiki/MOS_Technology_6502)

---

**文档范围：** 6502 CPU 的软件仿真  
**受众：** 仿真器开发者、复古计算工程师  
**状态：** 稳定技术参考
