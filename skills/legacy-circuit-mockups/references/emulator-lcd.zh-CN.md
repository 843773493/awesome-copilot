# DFRobot FIT0127 字符液晶显示屏模拟规范

## 概述

本文件规定了如何**模拟 DFRobot FIT0127 字符液晶显示屏模块**。FIT0127 是一款**16x2 字符液晶显示屏**，兼容**HD44780 控制器**，常用于 6502 和单片机面包板系统中。

目标是**实现功能正确性**，适用于 SBC 模拟器、固件测试和用户界面可视化，而非对电气信号进行仿真。

---

## 模块摘要

| 特性          | 值                   |
| ------------- | -------------------- |
| 显示类型       | 字符液晶显示屏        |
| 分辨率         | 16 列 x 2 行         |
| 控制器         | HD44780 兼容型        |
| 接口           | 8 位或 4 位并行       |
| 字符矩阵       | 5x8 点阵             |
| 供电电压       | 5V                   |

---

## 引脚定义

| 引脚 | 名称 | 功能         |
| ---- | ---- | ------------ |
| 1    | GND  | 地线         |
| 2    | VCC  | +5V 电源      |
| 3    | VO   | 对比度控制    |
| 4    | RS   | 寄存器选择    |
| 5    | R/W  | 读/写         |
| 6    | E    | 使能信号      |
| 7-14 | D0-D7 | 数据总线     |
| 15   | A    | 背光正极      |
| 16   | K    | 背光负极      |

---

## 逻辑寄存器

| RS | 寄存器             |
| -- | ------------------ |
| 0  | 指令寄存器          |
| 1  | 数据寄存器          |

---

## 指令集（部分）

| 命令         | 代码        | 描述               |
| ------------ | ----------- | ------------------ |
| 清屏         | `0x01`      | 清除 DDRAM，光标归位 |
| 光标回位     | `0x02`      | 光标回到初始位置     |
| 入口模式设置  | `0x04-0x07` | 光标方向           |
| 显示控制      | `0x08-0x0F` | 显示、光标、闪烁     |
| 光标/移位     | `0x10-0x1F` | 光标或显示移位       |
| 功能设置      | `0x20-0x3F` | 数据长度、行数       |
| 设置 CGRAM 地址 | `0x40-0x7F` | 自定义字符          |
| 设置 DDRAM 地址 | `0x80-0xFF` | 光标位置            |

---

## 内部内存模型

### DDRAM（显示数据 RAM）

* 大小：80 字节
* 第 1 行起始地址：`0x00`
* 第 2 行起始地址：`0x40`

模拟器映射：

```text
第 0 行：DDRAM[0x00-0x0F]
第 1 行：DDRAM[0x40-0x4F]
```

### CGRAM（字符生成 RAM）

* 存储最多 8 个自定义字符
* 每个字符占用 8 字节

---

## 数据写入周期

当以下条件满足时发生写入：

```
RS = 1
R/W = 0
E: 高电平 → 低电平
```

### 模拟器行为

* 在 E 信号下降沿锁存数据
* 根据地址模式将数据写入 DDRAM 或 CGRAM
* 根据入口模式自动递增或递减地址

---

## 指令写入周期

当以下条件满足时发生指令写入：

```
RS = 0
R/W = 0
E: 高电平 → 低电平
```

---

## 读取周期（可选）

在业余系统中读取操作较为少见。

```
RS = 0/1
R/W = 1
E: 高电平
```

模拟器可简化处理：

* 忽略所有读取操作
* 或返回忙标志 + 地址计数器

---

## 忙标志模拟

### 实际硬件

* 忙标志 = D7
* 指令执行时间：37-1520 微秒

### 模拟器选项

| 模式       | 行为          |
| ---------- | ------------- |
| 简化模式    | 始终就绪      |
| 定时模式    | 忙状态持续 N 个周期 |

推荐默认模式：**始终就绪**

---

## 上电状态

复位后：

* 显示关闭
* 光标关闭
* DDRAM 清除或未定义
* 地址计数器 = 0

模拟器应：

* 清除 DDRAM
* 设置光标位置为 (0,0)
* 启用显示

---

## 光标与显示模型

状态变量：

```text
cursor_row
cursor_col
display_on
cursor_on
blink_on
```

光标在写入后根据入口模式自动移动。

---

## 4 位接口 vs 8 位接口

### 8 位模式

* D0-D7 总线传输完整字节

### 4 位模式

* 每个字节先发送高半字节
* 每个字节需两次使能信号

模拟器简化处理：

* 接受完整字节写入
* 忽略半字节时序

---

## 渲染模型（模拟器 UI）

推荐方法：

* 保持 16x2 字符缓冲区
* 渲染 ASCII 子集
* 替换不支持的字符
* 可选地渲染自定义 CGRAM 字符

---

## 模拟器 API 模型

```c
typedef struct {
    uint8_t ddram[80];
    uint8_t cgram[64];
    uint8_t addr;
    bool display_on;
    bool cursor_on;
    bool blink_on;
    uint8_t entry_mode;
} FIT0127_LCD;
```

---

## 6502 系统常见接线方式

```
VIA 端口  LCD D4-D7（4 位模式）
RS  VIA 位
E   VIA 位
R/W  地线
```

---

## 测试清单

* 清屏指令
* 通过 DDRAM 地址定位光标
* 顺序字符写入
* 换行行为
* 自定义字符显示

---

## 参考资料

* [HD44780U 数据手册（日立）](https://academy.cba.mit.edu/classes/output_devices/44780.pdf)
* [Ben Eater LCD 接口说明](https://hackaday.io/project/174128-db6502/log/181838-adventures-with-hd44780-lcd-controller)
* [Ben Eater 的 6502 计算机](https://github.com/tedkotz/be6502)
* [构建 6502 计算机](https://eater.net/6502)

---

## 说明

本规范有意优先考虑**固件可见行为**而非电气信号的准确性，因此非常适合用于以下场景：

* SBC 模拟器
* ROM 和监控程序开发
* LCD 输出的自动化测试
* 教育类 CPU 项目
