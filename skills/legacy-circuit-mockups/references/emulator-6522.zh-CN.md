# 6522 VIA（多功能接口适配器）模拟规范

适用于**6502系列模拟器、单板计算机（SBC）模拟器和复古计算软件环境**的MOS Technology / WDC 6522 VIA功能模拟技术Markdown规范。

---

## 1. 范围

本文件定义了模拟以下功能所需的行为：

* MOS Technology 6522 VIA
* WDC 65C22 VIA（CMOS版本，注释中特别说明）

不在范围内：

* 模拟电气特性
* 总线竞争和传播延迟
* 未记录的硅芯片竞争条件

---

## 2. 芯片概述

### 核心功能

| 功能          | 描述                          |
| ------------- | ----------------------------- |
| I/O端口        | 两个双向8位端口（A、B）         |
| 定时器         | 两个可编程定时器               |
| 移位寄存器     | 8位串行移位寄存器              |
| 中断系统       | 可屏蔽、优先级处理             |
| 握手信号       | CA1/CA2、CB1/CB2控制线          |

---

## 3. 外部信号（逻辑模型）

| 信号   | 方向 | 用途                  |
| ------ | ---- | -------------------- |
| PA0-PA7  | I/O  | 端口A               |
| PB0-PB7  | I/O  | 端口B               |
| CA1, CA2 | I/O  | 控制线A              |
| CB1, CB2 | I/O  | 控制线B              |
| IRQ     | 输出 | 向CPU发送中断请求     |
| CS1, CS2 | 输入  | 芯片选择             |
| R/W     | 输入  | 读/写               |
| RS0-RS3 | 输入  | 寄存器选择           |

---

## 4. 寄存器映射

通过RS3-RS0选择寄存器。

| 地址 | 名称        | R/W | 描述                      |
| ---- | ----------- | --- | ------------------------- |
| 0    | ORB / IRB   | R/W | 输出/输入寄存器B          |
| 1    | ORA / IRA   | R/W | 输出/输入寄存器A          |
| 2    | DDRB        | R/W | 数据方向寄存器B           |
| 3    | DDRA        | R/W | 数据方向寄存器A           |
| 4    | T1C-L       | R   | 定时器1计数器低字节       |
| 5    | T1C-H       | R   | 定时器1计数器高字节       |
| 6    | T1L-L       | W   | 定时器1锁存低字节         |
| 7    | T1L-H       | W   | 定时器1锁存高字节         |
| 8    | T2C-L       | R   | 定时器2计数器低字节       |
| 9    | T2C-H       | R   | 定时器2计数器高字节       |
| 10   | SR          | R/W | 移位寄存器                |
| 11   | ACR         | R/W | 辅助控制寄存器            |
| 12   | PCR         | R/W | 外设控制寄存器            |
| 13   | IFR         | R/W | 中断标志寄存器            |
| 14   | IER         | R/W | 中断使能寄存器            |
| 15   | ORA (无HS)  | R/W | 输出寄存器A（无握手）     |

---

## 5. 数据方向寄存器

* 位 = 1  输出
* 位 = 0  输入

```text
输出 = ORx 与 DDRx 的按位与
输入  = 外部信号 与 ~DDRx
```

---

## 6. 端口行为

### 读取

* 返回配置为输入的引脚状态
* 返回配置为输出的锁存器值

### 写入

* 仅更新输出锁存器
* 实际引脚值取决于DDR

---

## 7. 定时器

### 定时器1（T1）

* 16位递减计数器
* 可生成中断
* 可选PB7翻转功能

### 定时器2（T2）

* 16位递减计数器
* 单次或脉冲计数（CB1）

### 定时器模拟规则

* 每个CPU周期递减一次
* 在适当的时候从锁存器重新加载
* 下溢时设置中断标志

---

## 8. 移位寄存器（SR）

通过ACR控制模式：

* 禁用
* 在CB1时钟下移入
* 在系统时钟下移出

模拟器要求：

* 8位移位
* 正确的位顺序
* 可选外部时钟处理

---

## 9. 控制寄存器

### 辅助控制寄存器（ACR）

控制功能：

* 定时器1模式
* 定时器2模式
* 移位寄存器模式
* PB7行为

### 外设控制寄存器（PCR）

控制功能：

* CA1/CB1边沿敏感性
* CA2/CB2握手/脉冲/输出模式

---

## 10. 中断系统

### 中断标志寄存器（IFR）

| 位 | 源                     |
| -- | ---------------------- |
| 0  | CA2                    |
| 1  | CA1                    |
| 2  | 移位寄存器              |
| 3  | CB2                    |
| 4  | CB1                    |
| 5  | 定时器2                 |
| 6  | 定时器1                 |
| 7  | 任意中断（逻辑或）        |

### 中断使能寄存器（IER）

* 位7 = 设置/清除模式
* 位0-6启用单个中断源

### IRQ逻辑

```text
IRQ = (IFR & IER & 0x7F) != 0
```

---

## 11. 握手信号线

### CA1 / CB1

* 边沿检测输入
* 触发中断

### CA2 / CB2

* 输入或输出
* 脉冲或握手模式

模拟器必须：

* 跟踪引脚状态
* 检测配置的边沿

---

## 12. 复位行为

复位后：

* DDRx = $00
* ORx = $00
* 定时器停止
* IFR清零
* IER清零
* IRQ无效

---

## 13. 读/写副作用

| 寄存器    | 副作用              |
| -------- | ------------------- |
| ORA/ORB  | 清除握手标志         |
| T1C-H写入 | 加载并启动定时器1     |
| IFR写入  | 清除写入的位         |
| IER写入  | 设置或清除使能       |

---

## 14. 模拟时序级别

| 级别          | 描述                   |
| ------------ | ---------------------- |
| 功能级       | 正确的寄存器行为         |
| 基于周期的    | 定时器每CPU周期递减       |
| 精确周期的    | 匹配实际VIA时序         |

---

## 15. 与6502模拟器的集成

```text
CPU周期  VIA时钟  更新定时器  更新IRQ
```

* VIA必须与CPU同步时钟
* CPU在指令边界采样IRQ线

---

## 16. 测试与验证

### 推荐测试

* VIA定时器测试ROM
* 端口读/写测试
* 中断优先级测试

### 验证检查清单

* 定时器计数正确
* IRQ正确置位和清除
* DDR行为正确
* 实现了所有副作用

---

## 17. 差异：6522 vs 65C22（摘要）

| 功能        | 6522   | 65C22    |
| ----------- | ------ | -------- |
| 电源        | 高功耗 | 低功耗   |
| 十进制特性  | 无     | 固定     |
| 定时器精度  | NMOS   | 改进     |

---

## 18. 参考链接

* [https://www.westerndesigncenter.com/wdc/documentation](https://www.westerndesigncenter.com/wdc/documentation)
* [https://www.princeton.edu/~mae412/HANDOUTS/Datasheets/6522.pdf](https://www.princeton.edu/~mae412/HANDOUTS/Datasheets/6522.pdf)
* [https://www.nesdev.org/wiki/6522](https://www.nesdev.org/wiki/6522)

---

**文档范围：** 6522 VIA的软件模拟  
**受众：** 模拟器开发人员、单板计算机（SBC）设计师  
**状态：** 稳定技术参考
