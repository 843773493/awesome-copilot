# AT28C256 电可擦可编程存储器（EEPROM）仿真规范

## 概述

本文件规定了如何在基于6502的系统模拟器中**仿真AT28C256（32 KB并行EEPROM）**。目标是实现*行为准确性*，适用于单板计算机（SBC）、监视器和真实ROM图像，而不仅仅是通用的基于文件的存储。

AT28C256通常用作**ROM**在6502系统中，但它具有*电可擦写*特性，并且其时序行为与SRAM不同。

---

## 芯片概述

| 参数         | 值                  |
|--------------|---------------------|
| 容量         | 32 KB（256 Kbit）   |
| 组织方式     | 32,768 x 8          |
| 地址线       | A0-A14              |
| 数据线       | D0-D7               |
| 供电电压     | 5V                  |
| 典型用途     | ROM / 固件存储      |

---

## 引脚定义

| 引脚 | 名称         | 功能               |
|------|--------------|--------------------|
| A0-A14 | 地址         | 字节地址           |
| D0-D7  | 数据         | 数据总线           |
| /CE   | 片选使能     | 激活芯片           |
| /OE   | 输出使能     | 启用输出驱动器     |
| /WE   | 写入使能     | 触发写入周期       |
| VCC   | +5V          | 电源               |
| GND   | 接地         | 参考电平           |

---

## 读取周期行为

当满足以下条件时会发生读取：

```
/CE = 0
/OE = 0
/WE = 1
```

### 读取规则

* 在`/OE`被激活前，地址必须保持稳定
* 数据在访问时间后出现在D0-D7上（大多数模拟器中忽略此时间）
* 当`/OE = 1`或`/CE = 1`时，输出处于**高阻态**

### 模拟器行为

```text
如果 CE == 0 且 OE == 0 且 WE == 1:
    数据总线 = 存储器[地址]
否则:
    数据总线 = Z
```

---

## 写入周期行为

当满足以下条件时会发生写入：

```
/CE = 0
/WE = 0
```

（在写入期间，`/OE`通常为高电平）

### 重要的EEPROM特性

* 写入操作**不是瞬时的**
* 每次写入会触发一个**内部编程周期**
* 在编程过程中，读取可能会返回未定义数据

---

## 写入时序模型（简化版）

### 实际硬件

| 参数         | 典型值     |
|--------------|------------|
| 字节写入时间 | ~200 µs    |
| 页面大小     | 64字节     |
| 页面写入时间 | ~10 ms     |

### 模拟器简化选项

#### 选项A - 瞬时写入（常见）

* 写入立即更新存储器
* 无忙碌状态
* 建议用于早期模拟器

#### 选项B - 基于周期的忙碌状态（高级）

* 跟踪一个“写入进行中”的计时器
* 写入期间读取返回最后值或`0xFF`
* 写入操作在周期完成前被忽略

---

## 页面写入仿真（可选）

* 页面大小：**64字节**
* 在超时前同一页面内的写入会合并执行
* 跨越页面边界时数据会绕回当前页面（硬件特性）

简化规则：

```text
page_base = 地址 & 0xFFC0
page_offset = 地址 & 0x003F
```

---

## 写入保护行为

某些系统在编程后将EEPROM视为**只读ROM**。

模拟器可能支持：

* 只读模式（忽略写入操作）
* 可编程模式（允许写入）
* 运行时切换（模拟编程跳线）

---

## 上电状态

* EEPROM保留数据
* 上电时无未定义数据

模拟器应：

* 从图像文件加载内容
* 在复位时保留数据

---

## 总线竞争规则

| 条件           | 行为             |
|----------------|------------------|
| /CE = 1        | 数据总线 = Z      |
| /OE = 1        | 数据总线 = Z      |
| /WE = 0 且 /OE = 0 | 未定义（应避免） |

模拟器可能：

* 优先处理写入
* 或标记无效状态

---

## 6502系统中的内存映射

常见布局：

```
$0000-$7FFF  RAM
$8000-$FFFF  AT28C256 EEPROM
```

### 复位向量使用

| 向量 | 地址         |
|------|--------------|
| RESET | $FFFC-$FFFD  |
| NMI  | $FFFA-$FFFB  |
| IRQ  | $FFFE-$FFFF  |

---

## 模拟器API模型

```c
typedef struct {
    uint8_t 存储器[32768];
    bool 写入使能;
    bool 忙碌;
    uint32_t 忙碌周期数;
} AT28C256;
```

### 读取

```c
uint8_t eeprom_read(地址);
```

### 写入

```c
void eeprom_write(地址, 值);
```

---

## 推荐的模拟器默认设置

| 功能         | 设置         |
|--------------|--------------|
| 写入延迟     | 禁用         |
| 页面模式     | 禁用         |
| 写入保护     | 启用         |
| 持久性       | 基于文件的   |

---

## 测试检查清单

* 复位向量读取
* 正常执行下的ROM读取
* 只读模式下忽略写入操作
* 正确的地址掩码（15位）
* 禁用时无总线驱动

---

## 参考资料

* [AT28C256数据手册（Microchip）](https://ww1.microchip.com/downloads/aemDocuments/documents/MPD/ProductDocuments/DataSheets/AT28C256-Industrial-Grade-256-Kbit-Paged-Parallel-EEPROM-Data-Sheet-DS20006386.pdf)
* [Ben Eater 6502计算机系列](https://eater.net/6502)
  * <https://www.youtube.com/watch?v=oO8_2JJV0B4>
* [6502.org内存映射说明](https://6502.co.uk/lesson/memory-map)

---

## 说明

本规范有意地模拟**真实硬件特性**，同时允许模拟器作者在简单性和准确性之间进行选择。适用于：

* 教育性模拟器
* 单板计算机（SBC）仿真
* ROM开发流程
* 与6502 + 6522 + SRAM模拟集成
