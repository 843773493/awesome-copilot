# 错误处理指南

本参考文档记录了预检验证过程中常见的错误及其处理方法。

## 核心原则

**继续执行失败。** 将所有问题记录在最终报告中，而不是在第一个错误时停止。这为用户提供了一个完整的修复清单。

---

## 认证错误

### 未登录（Azure CLI）

**检测:**
```
错误：请运行 'az login' 来设置账户。
错误：AADSTS700082: 刷新令牌已过期
```

**退出码:** 非零

**处理:**
1. 在报告中记录错误
2. 包含修复步骤
3. 跳过剩余的 Azure CLI 命令
4. 如果可能，继续其他验证步骤

**报告条目:**
```markdown
#### ❌ Azure CLI 认证所需

- **严重程度:** 错误
- **来源:** az cli
- **信息:** 未登录到 Azure CLI
- **修复建议:** 运行 `az login` 进行认证，然后重新运行预检验证
- **文档:** https://learn.microsoft.com/en-us/cli/azure/authenticate-azure-cli
```

### 未登录（azd）

**检测:**
```
错误：未登录，运行 `azd auth login` 进行登录
```

**处理:**
1. 在报告中记录错误
2. 跳过 azd 命令
3. 建议运行 `azd auth login`

**报告条目:**
```markdown
#### ❌ Azure Developer CLI 认证所需

- **严重程度:** 错误
- **来源:** azd
- **信息:** 未登录到 Azure Developer CLI
- **修复建议:** 运行 `azd auth login` 进行认证，然后重新运行预检验证
```

### 令牌过期

**检测:**
```
AADSTS700024: 客户端声明不在有效时间范围内
AADSTS50173: 提供的授权已过期
```

**处理:**
1. 记录错误
2. 建议重新认证
3. 跳过 Azure 操作

---

## 权限错误

### RBAC 权限不足

**检测:**
```
AuthorizationFailed: 客户端 '...'（对象 ID 为 '...'）没有权限在作用域 '...' 上执行操作 '...'
```

**处理:**
1. **首次尝试:** 使用 `--validation-level ProviderNoRbac` 重新运行
2. 在报告中记录权限限制
3. 如果 ProviderNoRbac 也失败，报告具体的缺失权限

**报告条目:**
```markdown
#### ⚠️ 权限验证受限

- **严重程度:** 警告
- **来源:** what-if
- **信息:** 完整的 RBAC 验证失败；使用只读验证
- **详情:** 缺失权限：`Microsoft.Resources/deployments/write` 在作用域 `/subscriptions/xxx` 上
- **建议:** 在目标资源组上请求 Contributor 角色，或与管理员确认部署权限
```

### 资源组未找到

**检测:**
```
ResourceGroupNotFound: 无法找到资源组 'xxx'。
```

**处理:**
1. 在报告中记录
2. 建议创建资源组
3. 跳过该作用域的 what-if 验证

**报告条目:**
```markdown
#### ❌ 资源组不存在

- **严重程度:** 错误
- **来源:** what-if
- **信息:** 资源组 'my-rg' 不存在
- **修复建议:** 部署前创建资源组：
  ```bash
  az group create --name my-rg --location eastus
  ```
```

### 订阅访问被拒绝

**检测:**
```
SubscriptionNotFound: 无法找到订阅 'xxx'。
InvalidSubscriptionId: 订阅 '...' 无效
```

**处理:**
1. 在报告中记录
2. 建议检查订阅 ID
3. 列出可用的订阅

---

## Bicep 语法错误

### 编译错误

**检测:**
```
/path/main.bicep(22,51) : 错误 BCP064: 发现意外的标记
/path/main.bicep(10,5) : 错误 BCP018: 此处期望 "=" 符号
```

**处理:**
1. 解析错误输出中的行号/列号
2. 在报告中包含所有错误（不要在第一个错误时停止）
3. 继续 what-if 验证（可能提供额外上下文）

**报告条目:**
```markdown
#### ❌ Bicep 语法错误

- **严重程度:** 错误
- **来源:** bicep build
- **位置:** `main.bicep:22:51`
- **代码:** BCP064
- **信息:** 在插值表达式中发现意外的标记
- **修复建议:** 检查第 22 行的字符串插值语法
- **文档:** https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/diagnostics/bcp064
```

### 模块未找到

**检测:**
```
错误 BCP091: 读取文件时发生错误。找不到文件 '...'
错误 BCP190: 模块无效
```

**处理:**
1. 记录缺失的模块
2. 检查是否需要运行 `bicep restore`
3. 验证模块路径

### 参数文件问题

**检测:**
```
错误 BCP032: 值必须是编译时常量
错误 BCP035: 指定的对象缺少必需属性
```

**处理:**
1. 记录参数问题
2. 指出哪些参数存在问题
3. 提供修复建议

---

## 工具未安装

### 未找到 Azure CLI

**检测:**
```
'az' 不被识别为内部或外部命令
az: 命令未找到
```

**处理:**
1. 在报告中记录
2. 提供安装说明。
  - 如果可用，使用 Azure MCP 的 `extension_cli_install` 工具获取安装说明。
  - 否则查看 https://learn.microsoft.com/en-us/cli/azure/install-azure-cli。
3. 跳过 az 命令

**报告条目:**
```markdown
#### ⏭️ Azure CLI 未安装

- **严重程度:** 警告
- **来源:** 环境
- **信息:** Azure CLI（az）未安装或不在 PATH 中
- **修复建议:** 安装 Azure CLI <在此处添加安装说明>
- **影响:** 跳过了使用 az 命令的 what-if 验证
```

### 未找到 Bicep CLI

**检测:**
```
'bicep' 不被识别为内部或外部命令
bicep: 命令未找到
```

**处理:**
1. 在报告中记录
2. Azure CLI 可能内置了 Bicep - 尝试 `az bicep build`
3. 提供安装链接

**报告条目:**
```markdown
#### ⏭️ Bicep CLI 未安装

- **严重程度:** 警告
- **来源:** 环境
- **信息:** Bicep CLI 未安装
- **修复建议:** 安装 Bicep CLI: https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/install
- **影响:** 跳过了语法验证；Azure 将在 what-if 验证期间进行验证
```

### 未找到 Azure Developer CLI

**检测:**
```
'azd' 不被识别为内部或外部命令
azd: 命令未找到
```

**处理:**
1. 如果 `azure.yaml` 存在，则为必需项
2. 如果可能，回退到 az CLI 命令
3. 在报告中记录

---

## What-If 特定错误

### 嵌套模板限制

**检测:**
```
部署超过 500 个嵌套模板的限制
```

**处理:**
1. 作为警告记录（非错误）
2. 解释受影响的资源显示为 "Ignore"
3. 建议手动审查

### 模板链接不受支持

**检测:**
```
嵌套部署中的 templateLink 在 what-if 验证中不可见
```

**处理:**
1. 作为警告记录
2. 解释限制
3. 实际部署期间将验证资源

### 未评估的表达式

**检测:** 属性显示类似 `[utcNow()]` 的函数名而非值

**处理:**
1. 作为信息性内容记录
2. 解释这些表达式将在部署时评估
3. 不是错误

---

## 网络错误

### 超时

**检测:**
```
连接超时
请求超时
```

**处理:**
1. 建议重试
2. 检查网络连接
3. 可能表示 Azure 服务问题

### SSL/TLS 错误

**检测:**
```
SSL: CERTIFICATE_VERIFY_FAILED
无法获取本地颁发者证书
```

**处理:**
1. 在报告中记录
2. 可能表示代理或企业防火墙
3. 建议检查 SSL 设置

---

## 回退策略

当主验证失败时，按顺序尝试回退方案：

```
Provider（完整 RBAC 验证）
    ↓ 由于权限错误失败
ProviderNoRbac（不检查写入权限的验证）
    ↓ 也失败
Template（仅静态语法）
    ↓ 也失败
报告所有失败并跳过 what-if 分析
```

**始终继续生成报告**，即使所有验证步骤都失败。

---

## 错误报告聚合

当发生多个错误时，逻辑地进行聚合：

1. **按来源分组**（bicep、what-if、权限）
2. **按严重程度排序**（错误在警告之前）
3. **去重**相似错误
4. **在顶部提供汇总计数**

示例：
```markdown
## 问题

发现 **3 个错误** 和 **2 个警告**

### 错误 (3)

1. [Bicep 语法错误 - main.bicep:22:51](#error-1)
2. [Bicep 语法错误 - main.bicep:45:10](#error-2)
3. [资源组未找到](#error-3)

### 警告 (2)

1. [权限验证受限](#warning-1)
2. [嵌套模板数量已达上限](#warning-2)
```

---

## 退出码参考

| 工具 | 退出码 | 含义 |
|------|-----------|---------|
| az | 0 | 成功 |
| az | 1 | 一般错误 |
| az | 2 | 命令未找到 |
| az | 3 | 必需参数缺失 |
| azd | 0 | 成功 |
| azd | 1 | 错误 |
| bicep | 0 | 构建成功 |
| bicep | 1 | 构建失败（错误） |
| bicep | 2 | 构建成功但有警告 |
