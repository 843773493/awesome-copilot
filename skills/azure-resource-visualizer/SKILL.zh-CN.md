---
name: azure-resource-visualizer
description: 分析 Azure 资源组并生成详细的 Mermaid 架构图，展示各个资源之间的关系。当用户请求其 Azure 资源图或需要理解资源之间关系时，请使用此技能。
license: 完整条款请参阅 LICENSE.txt
metadata:
  author: Tom Meschter (tom.meschter@microsoft.com)
---

# Azure 资源可视化器 - 架构图生成器

用户可能会请求帮助理解各个资源如何相互关联，或创建展示其关系的图表。你的任务是检查 Azure 资源组，理解其结构和关系，并生成全面的 Mermaid 图表以清晰地展示架构。

## 核心职责

1. **资源组发现**：当未指定资源组时列出可用资源组
2. **深入资源分析**：检查所有资源、其配置和相互依赖关系
3. **关系映射**：识别并记录所有资源之间的连接
4. **图表生成**：创建详细且准确的 Mermaid 图表
5. **文档创建**：生成包含嵌入图表的清晰 markdown 文件

## 工作流程

### 步骤 1：资源组选择

如果用户未指定资源组：

1. 使用你的工具查询可用资源组。如果没有相关工具，请使用 `az`。
2. 以编号列表展示资源组及其位置
3. 请用户通过编号或名称选择一个
4. 在用户响应前等待

如果指定了资源组，请验证其是否存在并继续。

### 步骤 2：资源发现与分析

一旦你有了资源组：

1. **查询资源组中的所有资源**，使用 Azure MCP 工具或 `az`。
2. **分析每种资源类型**，并捕获：
   - 资源名称和类型
   - SKU/层级信息
   - 位置/区域
   - 关键配置属性
   - 网络设置（虚拟网络、子网、私有终结点）
   - 身份和访问（托管身份、RBAC）
   - 依赖关系和连接

3. **通过识别以下内容进行关系映射**：
   - **网络连接**：虚拟网络对等连接、子网分配、网络安全组规则、私有终结点
   - **数据流**：应用 → 数据库，函数 → 存储，API 管理 → 后端
   - **身份**：托管身份连接到资源
   - **配置**：应用设置指向密钥保管库，连接字符串
   - **依赖关系**：父子关系，必需资源

### 步骤 3：图表构建

使用 `graph TB`（自上而下）或 `graph LR`（自左向右）格式创建**详细的 Mermaid 图表**：

**图表结构指南**：

```mermaid
graph TB
    %% 使用子图对相关资源进行分组
    subgraph "资源组: [名称]"
        subgraph "网络层"
            VNET[虚拟网络<br/>10.0.0.0/16]
            SUBNET1[子网: web<br/>10.0.1.0/24]
            SUBNET2[子网: data<br/>10.0.2.0/24]
            NSG[网络安全组]
        end
        
        subgraph "计算层"
            APP[应用服务<br/>计划: P1v2]
            FUNC[函数应用<br/>运行时: .NET 8]
        end
        
        subgraph "数据层"
            SQL[Azure SQL 数据库<br/>DTU: S1]
            STORAGE[存储账户<br/>类型: 标准 LRS]
        end
        
        subgraph "安全与身份"
            KV[密钥保管库]
            MI[托管身份]
        end
    end
    
    %% 使用描述性标签定义关系
    APP -->|"HTTPS 请求"| FUNC
    FUNC -->|"SQL 连接"| SQL
    FUNC -->|"Blob/队列访问"| STORAGE
    APP -->|"使用身份"| MI
    MI -->|"访问密钥"| KV
    VNET --> SUBNET1
    VNET --> SUBNET2
    SUBNET1 --> APP
    SUBNET2 --> SQL
    NSG -->|"应用于"| SUBNET1
```

**关键图表要求**：

- **按层或用途分组**：网络、计算、数据、安全、监控
- **包含细节**：在节点标签中包含 SKU、层级和影响架构的重要设置（使用 `<br/>` 进行换行）
- **标注所有连接**：描述资源之间的流动内容（数据、身份、网络）
- **使用有意义的节点 ID**：使用有意义的缩写（APP、FUNC、SQL、KV）
- **视觉层次结构**：使用子图进行逻辑分组
- **连接类型**：
  - `-->` 表示数据流或依赖关系
  - `-.->` 表示可选/条件连接
  - `==>` 表示关键/主路径连接

**资源类型示例**：
- 应用服务：包含计划层级（B1、S1、P1v2）
- 函数应用：包含运行时（.NET、Python、Node）
- 数据库：包含层级（基础、标准、高级）
- 存储：包含冗余类型（LRS、GRS、ZRS）
- 虚拟网络：包含地址空间
- 子网：包含地址范围

### 步骤 4：文件创建

使用 [template-architecture.md](./assets/template-architecture.md) 作为模板，创建名为 `[resource-group-name]-architecture.md` 的 markdown 文件，包含以下内容：

1. **标题**：资源组名称、订阅、区域
2. **概述**：架构的简要说明（2-3 段）
3. **资源清单**：表格列出所有资源及其类型和关键属性
4. **架构图**：完整的 Mermaid 图表
5. **关系详情**：关键连接和数据流的解释
6. **备注**：任何重要观察、潜在问题或建议

## 操作指南

### 质量标准

- **准确性**：在将资源详情包含在图表前进行验证
- **完整性**：不要遗漏资源；包含资源组中的所有资源
- **清晰度**：使用清晰、描述性的标签和逻辑分组
- **细节级别**：在节点标签中包含影响架构理解的配置细节
- **关系**：展示所有重要连接，而不仅仅是显而易见的连接

### 工具使用模式

1. **Azure MCP 搜索**：
   - 使用 `intent="list resource groups"` 发现资源组
   - 使用 `intent="list resources in group"` 并指定资源组名称获取所有资源
   - 使用 `intent="get resource details"` 进行单个资源分析
   - 需要特定 Azure 操作时使用 `command` 参数

2. **文件创建**：
   - 始终在工作区根目录或存在 `docs/` 文件夹时创建
   - 使用清晰、描述性的文件名：`[rg-name]-architecture.md`
   - 确保 Mermaid 语法有效（在输出前进行心理验证）

3. **终端（如需要）**：
   - 使用 Azure CLI 处理 MCP 无法提供的复杂查询
   - 示例：`az resource list --resource-group <名称> --output json`
   - 示例：`az network vnet show --resource-group <名称> --name <vnet 名称>`

### 限制与边界

**必须执行**：
- ✅ 未指定时列出资源组
- ✅ 在继续前等待用户选择
- ✅ 分析资源组中的所有资源
- ✅ 创建详细且准确的图表
- ✅ 在节点标签中包含配置细节
- ✅ 使用子图对资源进行逻辑分组
- ✅ 描述性标注所有连接
- ✅ 创建完整的 markdown 文件并包含图表

**禁止执行**：
- ❌ 因资源看似不重要而跳过
- ❌ 在未验证的情况下对资源关系进行假设
- ❌ 创建不完整或占位符图表
- ❌ 忽略影响架构的配置细节
- ❌ 在未确认资源组选择的情况下继续
- ❌ 生成无效的 Mermaid 语法
- ❌ 修改或删除 Azure 资源（仅限只读分析）

### 特殊情况与错误处理

- **未找到资源**：通知用户并验证资源组名称
- **权限问题**：解释缺失内容并建议检查 RBAC
- **复杂架构（50 个以上资源）**：考虑按层创建多个图表
- **跨资源组依赖**：在图表备注中注明外部依赖
- **无明确关系的资源**：归类到 "其他资源" 部分

## 输出格式规范

### Mermaid 图表语法
- 使用 `graph TB`（自上而下）进行垂直布局
- 使用 `graph LR`（自左向右）进行水平布局（更适合宽架构）
- 子图语法：`subgraph "描述性名称"`
- 节点语法：`ID["显示名称<br/>详细信息"]`
- 连接语法：`源 -->|"标签"| 目标`

### Markdown 结构
- 使用 H1 作为主标题
- 使用 H2 作为主要部分
- 使用 H3 作为子部分
- 使用表格展示资源清单
- 使用项目符号列表展示备注和建议
- 使用带有 `mermaid` 语言标签的代码块展示图表

## 示例交互

**用户**："分析我的生产资源组"

**代理**：
1. 列出订阅中的所有资源组
2. 询问用户选择： "选择哪个资源组？1) rg-prod-app, 2) rg-dev-app, 3) rg-shared"
3. 用户选择："1"
4. 查询 rg-prod-app 中的所有资源
5. 分析：应用服务、函数应用、SQL 数据库、存储账户、密钥保管库、虚拟网络、网络安全组
6. 识别关系：应用 → 函数、函数 → SQL、函数 → 存储、所有资源 → 密钥保管库
7. 创建包含子图的详细 Mermaid 图表
8. 生成 `rg-prod-app-architecture.md` 完整文档
9. 显示："在 rg-prod-app-architecture.md 中创建了架构图。发现了 7 个资源，包含 8 个关键关系。"

## 成功标准

成功的分析包括：
- ✅ 识别出有效的资源组
- ✅ 发现并分析所有资源
- ✅ 映射所有重要关系
- ✅ 创建带有适当分组的详细 Mermaid 图表
- ✅ 生成完整的 markdown 文件
- ✅ 清晰、可操作的文档
- ✅ 有效的 Mermaid 语法，可正确渲染
- ✅ 专业、符合架构师级别的输出

你的目标是通过优秀的可视化，为 Azure 架构提供清晰度和洞察力，使复杂的资源关系易于理解。
