# 故障排除 — 诊断与常见问题

---

## 诊断代码

Aspire 会为常见问题生成诊断代码。这些代码会出现在构建警告/错误和 IDE 诊断中。

### 标准诊断代码

| 代码          | 严重程度 | 描述                                               |
| ------------- | -------- | -------------------------------------------------- |
| **ASPIRE001** | 警告     | 资源名称包含无效字符                               |
| **ASPIRE002** | 警告     | 检测到重复的资源名称                               |
| **ASPIRE003** | 错误     | 缺少必需的包引用                                   |
| **ASPIRE004** | 警告     | 使用了已弃用的 API                                 |
| **ASPIRE005** | 错误     | 无效的端点配置                                     |
| **ASPIRE006** | 警告     | 对于包含 `.WaitFor()` 的资源未配置健康检查         |
| **ASPIRE007** | 警告     | 未指定容器镜像标签（默认使用 `latest`）            |
| **ASPIRE008** | 错误     | 在资源图中检测到循环依赖                           |

### 实验性诊断代码 (ASPIREHOSTINGX\*)

这些代码表示使用了实验性/预览 API。如果您有意使用实验性功能，可能需要使用 `#pragma warning disable` 或 `<NoWarn>` 来禁用这些警告：

| 代码                      | 所属领域                         |
| ------------------------- | -------------------------------- |
| ASPIRE_HOSTINGX_0001–0005 | 实验性托管 API                   |
| ASPIRE_HOSTINGX_0006–0010 | 实验性集成 API                    |
| ASPIRE_HOSTINGX_0011–0015 | 实验性部署 API                     |
| ASPIRE_HOSTINGX_0016–0022 | 实验性资源模型 API                  |

要禁用实验性警告：

```xml
<!-- 在 .csproj 中 -->
<PropertyGroup>
  <NoWarn>$(NoWarn);ASPIRE_HOSTINGX_0001</NoWarn>
</PropertyGroup>
```

或逐行禁用：

```csharp
#pragma warning disable ASPIRE_HOSTINGX_0001
var resource = builder.AddExperimentalResource("test");
#pragma warning restore ASPIRE_HOSTINGX_0001
```

---

## 常见问题及解决方案

### 容器运行时

| 问题                           | 解决方案                                                                                               |
| --------------------------------- | ------------------------------------------------------------------------------------------------------ |
| "无法连接到 Docker 守护进程" | 启动 Docker Desktop / Podman / Rancher Desktop                                                        |
| 容器启动失败                     | 检查 `docker ps -a` 中的退出代码；检查仪表板控制台日志                                               |
| 端口已被占用                      | 另一进程正在使用该端口；Aspire 会自动分配，但 `targetPort` 必须在容器中可用                         |
| 容器镜像拉取失败                   | 检查网络连接；验证镜像名称和标签                                                                      |
| Linux 上出现 "权限被拒绝"         | 将用户添加到 `docker` 组：`sudo usermod -aG docker $USER`                                            |

### 服务发现

| 问题                       | 解决方案                                                                     |
| ----------------------------- | ---------------------------------------------------------------------------- |
| 服务找不到依赖项              | 在 AppHost 中验证 `.WithReference()`；检查仪表板中的环境变量               |
| 连接字符串为 null            | 引用资源名称不匹配；检查 `ConnectionStrings__<name>`                      |
| 服务 URL 中端口错误           | 检查 `targetPort` 与实际服务监听端口是否一致                             |
| 环境变量未设置               | 重新构建 AppHost；验证资源名称是否完全匹配                                |

### Python 工作负载

| 问题                           | 解决方案                                                        |
| --------------------------------- | --------------------------------------------------------------- |
| "未找到 Python"                   | 确保 Python 在 PATH 中；在 `AddPythonApp()` 中指定完整路径     |
| 未找到 venv                       | 使用 `.WithVirtualEnvironment()` 或手动创建 venv               |
| pip 包安装失败                     | 使用 `.WithPipPackages()` 或在 `aspire run` 前安装到 venv 中   |
| ModuleNotFoundError                | venv 未激活；`.WithVirtualEnvironment()` 会处理此问题           |
| Uvicorn 的 "端口已被占用"         | 检查 `targetPort` — 可能有其他实例正在运行                   |

### JavaScript / TypeScript 工作负载

| 问题                       | 解决方案                                                         |
| ----------------------------- | ---------------------------------------------------------------- |
| "未找到 node_modules"        | 使用 `.WithNpmPackageInstallation()` 自动安装                   |
| npm install 失败             | 检查 `package.json` 是否有效；检查 npm 注册表连接               |
| Vite 开发服务器无法启动     | 验证 `vite` 是否在 devDependencies 中；检查 Vite 配置           |
| 端口不匹配                   | 确保 `targetPort` 与 JS 框架配置中的端口一致                   |
| TypeScript 编译错误           | 这些错误发生在服务中，而非 Aspire — 检查服务日志               |

### Go 工作负载

| 问题                    | 解决方案                                                   |
| -------------------------- | ---------------------------------------------------------- |
| "未找到 go"             | 确保已安装 Go 并将其添加到 PATH                           |
| 构建失败                | 检查 `go.mod` 是否存在于工作目录                           |
| "目录中没有 Go 文件" | 验证 `workingDir` 是否指向包含 `main.go` 的目录             |

### Java 工作负载

| 问题                  | 解决方案                                                |
| ------------------------ | ------------------------------------------------------- |
| "java 未找到"         | 确保已安装 JDK 并设置 `JAVA_HOME`                    |
| Maven/Gradle 构建失败 | 验证构建文件是否存在；检查构建工具安装情况             |
| Spring Boot 无法启动  | 检查 `application.properties`；验证主类               |

### Rust 工作负载

| 问题              | 解决方案                                                             |
| -------------------- | -------------------------------------------------------------------- |
| "cargo 未找到"    | 通过 rustup 安装 Rust                                                |
| 构建耗时过长       | Rust 编译时间正常；使用 `.WithCargoBuild()` 进行预构建             |

### 健康检查与启动

| 问题                      | 解决方案                                                                       |
| ---------------------------- | ------------------------------------------------------------------------------ |
| 资源卡在 "Starting" 状态 | 健康检查端点未响应；检查服务日志                                             |
| `.WaitFor()` 超时         | 增加超时时间或修复健康检查端点；默认为 30 秒                               |
| 健康检查始终失败           | 验证端点路径（默认：`/health`）；检查服务是否绑定到正确端口               |
| 级联启动失败                | 依赖项失败；首先检查根资源                                                   |

### 仪表板

| 问题                               | 解决方案                                                                  |
| ------------------------------------- | ------------------------------------------------------------------------- |
| 仪表板无法打开                       | 检查终端中的 URL；使用 `--dashboard-port` 指定固定端口             |
| 无日志显示                           | 服务可能未将日志写入 stdout/stderr；检查控制台输出                 |
| 非 .NET 服务无追踪信息               | 在服务中配置 OpenTelemetry SDK；参见 [仪表板](dashboard.md)         |
| 追踪信息未显示跨服务调用 | 传播追踪上下文头（`traceparent`、`tracestate`）                   |

### 构建与配置

| 问题                                   | 解决方案                                                            |
| ----------------------------------------- | ------------------------------------------------------------------- |
| `AddProject<T>()` 的 "项目未找到" | 确保 `.csproj` 存在于解决方案中，并且由 AppHost 引用             |
| 包版本冲突                             | 将所有 Aspire 包固定为相同版本                                     |
| AppHost 无法构建                         | 检查 `Aspire.AppHost.Sdk` 是否在项目中；运行 `dotnet restore`    |
| `aspire run` 构建错误                   | 首先修复构建错误；`aspire run` 需要成功的构建                     |

### 部署

| 问题                                  | 解决方案                                                             |
| ---------------------------------------- | -------------------------------------------------------------------- |
| `aspire publish` 失败                   | 检查发布程序包是否已安装（例如 `Aspire.Hosting.Docker`）         |
| 生成的 Bicep 存在错误                   | 检查不支持的资源配置                                                 |
| 容器镜像推送失败                       | 验证注册表凭据和权限                                                   |
| 部署中缺少连接字符串 | 检查生成的 ConfigMaps/Secrets 是否与资源名称匹配                 |

---

## 调试策略

### 1. 首先检查仪表板

仪表板显示资源状态、日志、追踪信息和指标。遇到任何问题时，都应首先查看仪表板。

### 2. 检查环境变量

在仪表板中点击资源以查看所有注入的环境变量。验证连接字符串和服务 URL 是否正确。

### 3. 查看控制台日志

仪表板 → 控制台日志 → 按失败的资源进行过滤。原始 stdout/stderr 通常包含根本原因。

### 4. 检查 DAG

如果服务无法启动，检查依赖项顺序。失败的依赖项会阻止所有下游资源启动。

### 5. 使用 MCP 进行 AI 辅助调试

如果已配置 MCP（参见 [MCP 服务器](mcp-server.md)），请向您的 AI 助手提问：

- "哪些资源出现了故障？"
- "显示 [服务] 的日志"
- "哪些追踪信息显示错误？"

### 6. 隔离问题

通过注释掉 AppHost 中其他资源，仅运行失败的资源。这有助于判断问题是资源本身还是依赖项导致的。

---

## 获取帮助

| 渠道                 | URL                                            |
| ----------------------- | ---------------------------------------------- |
| GitHub 问题（运行时） | https://github.com/dotnet/aspire/issues        |
| GitHub 问题（文档）   | https://github.com/microsoft/aspire.dev/issues |
| Discord                | https://aka.ms/aspire/discord                  |
| Stack Overflow         | 标签: `dotnet-aspire`                           |
| Reddit                 | https://www.reddit.com/r/aspiredotdev/         |
