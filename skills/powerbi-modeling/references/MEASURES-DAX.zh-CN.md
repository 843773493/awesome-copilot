# DAX度量值与命名规范

## 命名规范

### 通用规则
- 使用可读性强的名称（允许使用空格）
- 描述清晰：使用如“总销售额”而非“TSA”
- 避免使用缩写，除非是普遍理解的
- 使用一致的大小写格式（推荐标题大小写）
- 避免使用特殊字符，除了空格

### 表命名
| 类型 | 规范 | 示例 |
|------|------|------|
| 维度表 | 单数名词 | 客户, 产品, 日期 |
| 事实表 | 业务流程 | 销售, 订单, 库存 |
| 桥接表 | 组合名称 | 客户账户, 产品类别 |
| 度量值表 | 下划线前缀 | _度量值, _KPIs |

### 列命名
| 类型 | 规范 | 示例 |
|------|------|------|
| 键 | 以"Key"或"ID"结尾 | 客户Key, 产品ID |
| 日期 | 以"Date"结尾 | 订单日期, 发货日期 |
| 金额 | 描述性名称并包含单位提示 | 销售额, 销售数量 |
| 标志 | 以"Is"或"Has"开头 | 是否活跃, 是否有折扣 |

### 度量值命名
| 类型 | 规范 | 示例 |
|------|------|------|
| 聚合 | 动词 + 名词 | 总销售额, 订单数量 |
| 比率 | X每Y或X比率 | 每客户的销售额, 转化率 |
| 时间智能 | 时期 + 指标 | 本年到目前为止的销售额, 去年同期总销售额 |
| 比较 | 指标 + vs + 基准 | 销售额 vs 预算, 增长 vs 去年 |

## 显式度量值与隐式度量值

### 始终为以下内容创建显式度量值：
1. 用户将查询的关键业务指标
2. 包含过滤器操作的复杂计算
3. 用于MDX（Excel数据透视表）的度量值
4. 受控聚合（防止对平均值求和）

### 隐式度量值（列聚合）
- 适用于简单的探索分析
- 设置正确的SummarizeBy属性：
  - 金额：求和
  - 键/ID：无（不进行汇总）
  - 比率/价格：无或平均值

## 度量值模式

### 基础聚合
```dax
总销售额 = SUM(销售[销售额])
订单数量 = COUNTROWS(销售)
平均订单价值 = DIVIDE(总销售额, 订单数量)
不同客户数量 = DISTINCTCOUNT(销售[客户Key])
```

### 时间智能（需要日期表）
```dax
本年到目前为止的销售额 = TOTALYTD(总销售额, '日期'[日期])
本月到目前为止的销售额 = TOTALMTD(总销售额, '日期'[日期])
去年同期销售额 = CALCULATE(总销售额, SAMEPERIODLASTYEAR('日期'[日期]))
同比增长率 = DIVIDE(总销售额 - 去年同期销售额, 去年同期销售额)
```

### 百分比计算
```dax
销售额占比 = 
DIVIDE(
    总销售额,
    CALCULATE(总销售额, REMOVEFILTERS(产品))
)

利润率 = DIVIDE(毛利润, 总销售额)
```

### 累计总和
```dax
累计销售额 = 
CALCULATE(
    总销售额,
    FILTER(
        ALL('日期'),
        '日期'[日期] <= MAX('日期'[日期])
    )
)
```

## 列引用

### 最佳实践：始终对列名进行限定
```dax
// 良好 - 完全限定
销售额 = SUM(销售[销售额])

// 不良 - 未限定（可能导致歧义）
销售额 = SUM([销售额])
```

### 度量值引用：从不进行限定
```dax
// 良好 - 未限定的度量值
本年到目前为止的销售额 = TOTALYTD(总销售额, '日期'[日期])

// 不良 - 限定的度量值（如果主表更改会导致错误）
本年到目前为止的销售额 = TOTALYTD(销售[总销售额], '日期'[日期])
```

## 文档说明

### 度量值描述
始终添加解释以下内容的描述：
- 该度量值计算什么
- 业务背景/用途
- 任何重要的假设

```
measure_operations(
  operation: "Update",
  definitions: [{
    name: "总销售额",
    tableName: "销售",
    description: "所有已完成销售交易的总和。排除退货和取消订单。"
  }]
)
```

### 格式字符串
| 数据类型 | 格式字符串 | 示例输出 |
|----------|------------|----------|
| 货币 | $#,##0.00 | $1,234.56 |
| 百分比 | 0.0% | 12.3% |
| 整数 | #,##0 | 1,234 |
| 小数 | #,##0.00 | 1,234.56 |

## 显示文件夹

将度量值组织到逻辑分组中：
```
measure_operations(
  operation: "Update",
  definitions: [{
    name: "本年到目前为止的销售额",
    tableName: "_度量值",
    displayFolder: "时间智能\\年"
  }]
)
```

常见文件夹结构：
```
_Measures
├── 销售
│   ├── 总销售额
│   └── 平均销售额
├── 时间智能
│   ├── 年
│   │   ├── 本年到目前为止的销售额
│   │   └── 去年同期销售额
│   └── 月
│       └── 本月到目前为止的销售额
└── 比率
    ├── 利润率
    └── 转化率
```

## 用于性能的变量

使用变量来：
- 避免重复计算相同表达式
- 提高可读性
- 便于调试

```dax
利润率 = 
VAR 总销售额 = 总销售额
VAR 总成本 = 总成本
VAR 毛利润 = 总销售额 - 总成本
RETURN
    DIVIDE(毛利润, 总销售额)
```

## 验证检查清单

- [ ] 所有关键业务指标都有显式度量值
- [ ] 度量值具有清晰、描述性的名称
- [ ] 度量值有描述
- [ ] 应用了适当的格式字符串
- [ ] 显示文件夹组织相关度量值
- [ ] 列引用始终完全限定
- [ ] 度量值引用从不进行限定
- [ ] 使用变量处理复杂计算
