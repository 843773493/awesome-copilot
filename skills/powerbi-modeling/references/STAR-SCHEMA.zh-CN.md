# Power BI 的星型架构设计

## 概述

星型架构是 Power BI 语义模型的最优设计模式。它将数据组织为：
- **维度表**：用于过滤和分组（“一”对多的一侧）
- **事实表**：用于汇总（“多”对一的一侧）

## 表分类

### 维度表
- 包含用于过滤/切片的描述性属性
- 包含唯一主键列（每个实体一行）
- 示例：客户、产品、日期、地理、员工
- 命名规范：使用单数名词（`Customer`、`Product`）

### 事实表  
- 包含可测量的、定量的数据
- 包含指向维度的外键
- 存储数据时需保持一致的粒度（每行对应一个交易/事件）
- 示例：销售、订单、库存、网页访问
- 命名规范：使用业务流程名词（`Sales`、`Orders`）

## 设计原则

### 1. 分离维度与事实
```
不推荐：单个反规范化的 "Sales" 表包含客户详细信息
推荐："Sales" 事实表 + "Customer" 维度表
```

### 2. 一致的粒度
事实表中的每一行都代表相同的事物：
- 订单行级别（最常见的）
- 每日聚合
- 每月摘要

永远不要在一个表中混合不同的粒度。

### 3. 代理键
当源数据缺乏唯一标识符时添加代理键：
```m
// Power Query: 添加索引列
= Table.AddIndexColumn(Source, "CustomerKey", 1, 1)
```

### 4. 日期维度
始终创建一个专用的日期表：
- 在 Power BI 中标记为日期表
- 如有需要，包含财年期间
- 添加相对日期列（如 IsCurrentMonth、IsPreviousYear）

```dax
Date = 
ADDCOLUMNS(
    CALENDAR(DATE(2020,1,1), DATE(2030,12,31)),
    "Year", YEAR([Date]),
    "Month", FORMAT([Date], "MMMM"),
    "MonthNum", MONTH([Date]),
    "Quarter", "Q" & FORMAT([Date], "Q"),
    "WeekDay", FORMAT([Date], "dddd")
)
```

## 避免的特殊维度类型

### 角色扮演维度
同一维度表被多次使用（例如日期维度用于 OrderDate、ShipDate）：
- 方案 1：复制表（OrderDate、ShipDate 表）
- 方案 2：使用不活动关系并结合 DAX 中的 USERELATIONSHIP

### 缓慢变化维度（类型 2）
通过版本列跟踪历史变化：
- 开始日期、结束日期列
- 是否为当前版本标志
- 需要在数据仓库中预先处理

### 垃圾维度
将低基数的标志列合并到一个表中：
```
OrderFlags 维度表：IsRush、IsGift、IsOnline
```

### 退化维度
在事实表中保留交易标识符（OrderNumber、InvoiceID）。

## 需要避免的反模式

| 反模式 | 问题 | 解决方案 |
|--------|------|----------|
| 宽表（反规范化） | 性能差，难以维护 | 拆分为星型架构 |
| 雪花模式（规范化维度） | 额外的连接影响性能 | 扁平化维度 |
| 多对多关系缺少桥梁表 | 结果模糊 | 添加桥梁/连接表 |
| 粒度混杂的事实表 | 汇总错误 | 按粒度拆分表 |

## 验证检查清单

- [ ] 每个表都明确为维度表或事实表
- [ ] 事实表包含指向所有相关维度的外键
- [ ] 维度表包含唯一主键列
- [ ] 存在日期表并已标记
- [ ] 没有循环关系路径
- [ ] 命名规范一致
