# Power BI 中的关系

## 关系属性

### 基数
| 类型 | 使用场景 | 说明 |
|------|----------|-------|
| 一对多 (*:1) | 维度表与事实表 | 最常见，推荐使用 |
| 多对一 (1:*) | 事实表到维度表 | 与上述相同，方向相反 |
| 一对一 (1:1) | 维度扩展 | 稀少使用 |
| 多对多 (*:*) | 桥接表、复杂场景 | 需谨慎设计 |

### 跨筛选方向
| 设置 | 行为 | 使用场景 |
|---------|----------|-------------|
| 单向 | 筛选从 "一" 流向 "多" | 默认设置，性能最佳 |
| 双向 | 筛选在两个方向流动 | 仅在必要时使用 |

## 最佳实践

### 1. 优先使用一对多关系
```
客户 (1) --> (*) 销售
产品  (1) --> (*) 销售
日期     (1) --> (*) 销售
```

### 2. 使用单向跨筛选
双向筛选：
- 对性能产生负面影响
- 可能导致筛选路径歧义
- 可能产生意外结果

**仅在以下情况下使用双向筛选：**
- 通过事实表进行维度到维度的分析
- 特定的 RLS（行级安全性）需求

**更好的替代方案：** 使用 DAX 测量中的 CROSSFILTER：
```dax
Countries Sold = 
CALCULATE(
    DISTINCTCOUNT(Customer[Country]),
    CROSSFILTER(Customer[CustomerKey], Sales[CustomerKey], BOTH)
)
```

### 3. 表之间仅有一条活动路径
- 任意两个表之间仅有一条活动关系
- 使用 USERELATIONSHIP 处理角色扮演维度：

```dax
按发货日期的销售 = 
CALCULATE(
    [总销售额],
    USERELATIONSHIP(Sales[ShipDate], Date[Date])
)
```

### 4. 避免歧义路径
循环引用会导致错误。解决方案：
- 停用一条关系
- 重构模型
- 在度量中使用 USERELATIONSHIP

## 关系模式

### 标准星型架构
```
     [日期]
       |
[产品]--[销售]--[客户]
       |
   [门店]
```

### 角色扮演维度
```
[日期] --(活动)-- [销售.订单日期]
   |
   +--(非活动)-- [销售.发货日期]
```

### 桥接表（多对多）
```
[客户]--(*)--[客户账户]--(*)--[账户]
```

### 无事实表（无度量关系）
```
[产品]--[产品促销]--[促销]
```
用于记录无度量的关系。

## 通过 MCP 创建关系

### 列出当前关系
```
relationship_operations(operation: "List")
```

### 创建新关系
```
relationship_operations(
  operation: "Create",
  definitions: [{
    fromTable: "销售",
    fromColumn: "产品键",
    toTable: "产品", 
    toColumn: "产品键",
    crossFilteringBehavior: "OneDirection",
    isActive: true
  }]
)
```

### 停用关系
```
relationship_operations(
  operation: "Deactivate",
  references: [{ name: "此处填写关系标识符" }]
)
```

## 故障排除

### "歧义路径" 错误
表之间存在多条活动路径。
- 检查内容：多个事实表共享维度
- 解决方案：停用冗余关系

### "双向过滤不允许"
将创建循环引用。
- 解决方案：重构模型或使用 DAX CROSSFILTER

### 未检测到关系
列可能具有不同的数据类型。
- 确保两列的数据类型完全一致
- 检查文本键是否存在尾随空格

## 验证检查清单

- [ ] 所有关系尽可能使用一对多
- [ ] 跨筛选默认为单向
- [ ] 任意两个表之间仅有一条活动路径
- [ ] 角色扮演维度使用非活动关系
- [ ] 不存在循环引用路径
- [ ] 主键列的数据类型匹配
