

---
描述：C# 应用程序构建指南 by @tsubakimoto
applyTo: '**/*.cs'
---

# C# 应用程序开发

## C# 指南
- 始终使用最新的 C#。目前使用的是 C# 14 的功能。
- 为每个函数编写清晰且简洁的注释。

## 一般指南
- 在代码修改的评审中，仅提出有把握的建议。
- 编写代码时，包含解释设计决策的注释等，以遵循高可维护性的实践。
- 处理边缘情况，并编写明确的异常处理。
- 对于库或外部依赖项，请在注释中明确其用途和目的。

## 命名规则

- 组件名、方法名和公开成员使用 PascalCase。
- 私有字段和局部变量使用 camelCase。
- 接口名以 "I" 作为前缀（例如: IUserService）。

## 格式

- 应用由 .editorconfig 定义的代码格式样式。
- 推荐使用文件作用域的 namespace 声明和单行的 using 指令。
- 在任意代码块（if、for、while、foreach、using、try 等）的开始大括号前换行。
- 方法的最终 return 语句应单独成行。
- 尽可能使用模式匹配和 switch 表达式。
- 使用 `nameof` 而不是字符串字面量进行成员名引用。
- 为所有公开 API 创建 XML 文档注释。如果可能，包含 `<example>` 和 `<code>` 标签。

## 项目设置与配置

- 指导使用适当的模板创建新的 .NET 项目。
- 解释生成的每个文件和文件夹的目的，以帮助理解项目结构。
- 展示功能文件夹和领域驱动设计（DDD）的组织方法。
- 展示通过模型、服务和数据访问层实现职责分离。
- 解释 ASP.NET Core 10 中的 Program.cs 和配置系统，以及环境特定的配置。

## 可空引用类型

- 将变量声明为非 null，并在入口点检查 null。
- 使用 `is null` 或 `is not null` 而不是 `== null` 或 `!= null`。
- 信任 C# 的 null 注释，如果类型系统已保证值的非 null 性，则不添加不必要的 null 检查。

## 数据访问模式

- 指导使用 Entity Framework Core 实现数据访问层。
- 解释开发和生产环境中的选项（SQL Server、SQLite、In-Memory）。
- 实现仓储模式及其适用场景。
- 展示数据库迁移和数据播种的实现方法。
- 解释避免常见性能问题的高效查询模式。

## 认证与授权

- 指导实现基于 JWT 裸令牌的认证。
- 解释与 ASP.NET Core 相关的 OAuth 2.0 和 OpenID Connect 概念。
- 展示基于角色和策略的授权实现方法。
- 展示与 Microsoft Entra ID（旧 Azure AD）的集成。
- 解释如何一致地保护基于控制器的 API 和 Minimal API。

## 验证与错误处理

- 指导使用数据注释和 FluentValidation 实现模型验证。
- 解释验证管道和自定义验证响应的方法。
- 展示使用中间件实现全局异常处理策略。
- 展示如何在整个 API 中创建一致的错误响应。
- 解释 Problem Details（RFC 7807）的实现方法，以标准化错误响应。

## API 版本控制与文档

- 指导实现 API 版本控制策略及其说明。
- 展示带有适当文档的 Swagger / OpenAPI 实现。
- 展示端点、参数、响应和认证的文档化方法。
- 解释在基于控制器的 API 和 Minimal API 中的版本控制方法。
- 指导创建对用户有帮助的有意义的 API 文档。

## 日志记录与监控

- 指导实现使用 Serilog 等的结构化日志记录。
- 解释日志级别以及各自适用的场景。
- 展示与 Application Insights 集成以收集遥测数据。
- 展示实现自定义遥测和相关 ID 的方法，用于请求追踪。
- 解释监控 API 性能、错误和使用模式的方法。

## 测试

- 在应用程序的重要路径中始终包含测试用例。
- 指导创建单元测试。
- 不编写 "Act"、"Arrange"、"Assert" 的注释。
- 与相邻文件的现有风格（测试方法名和大小写）保持一致。
- 解释 API 端点的集成测试方法。
- 展示如何通过模拟依赖项实现高效的测试。
- 展示认证和授权逻辑的测试方法。
- 解释适用于 API 开发的测试驱动开发（TDD）原则。

## 性能优化

- 指导实现缓存策略（内存、分布式、响应缓存）。
- 解释异步编程模式及其在 API 性能中的重要性。
- 展示针对大规模数据集的分页、过滤和排序方法。
- 展示实现性能优化（如压缩）的方法。
- 解释测量和基准测试 API 性能的方法。