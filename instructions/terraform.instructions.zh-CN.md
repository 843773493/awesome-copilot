

---
description: 'Terraform 规范与指南'
applyTo: '**/*.tf'
---

# Terraform 规范

## 通用指南

- 使用 Terraform 来部署和管理基础设施。
- 对您的 Terraform 配置使用版本控制。

## 安全性

- 始终使用 Terraform 及其提供者的最新稳定版本。
  - 定期更新您的 Terraform 配置以包含安全补丁和改进。
- 以安全的方式存储敏感信息，例如使用 AWS Secrets Manager 或 SSM Parameter Store。
  - 定期轮换凭证和密钥。
  - 尽可能自动化密钥轮换。
- 使用 AWS 环境变量来引用存储在 AWS Secrets Manager 或 SSM Parameter Store 中的值。
  - 这样可以将敏感值保留在 Terraform 状态文件之外。
- 绝不要将敏感信息（如 AWS 凭证、API 密钥、密码、证书或 Terraform 状态）提交到版本控制中。
  - 使用 `.gitignore` 排除包含敏感信息的文件。
- 在您的 Terraform 配置中始终将敏感变量标记为 `sensitive = true`。
  - 这样可以防止敏感值在 Terraform plan 或 apply 输出中显示。
- 使用 IAM 角色和策略来控制对资源的访问。
  - 在分配权限时遵循最小特权原则。
- 使用安全组和网络 ACL 来控制对资源的网络访问。
- 尽可能在私有子网中部署资源。
  - 仅在需要直接互联网访问的资源（如负载均衡器或 NAT 网关）时使用公共子网。
- 对静态存储和传输中的敏感数据使用加密。
  - 为 EBS 卷、S3 存储桶和 RDS 实例启用加密。
  - 在服务之间通信时使用 TLS。
- 定期审查和审计您的 Terraform 配置以查找安全漏洞。
  - 使用 `trivy`、`tfsec` 或 `checkov` 等工具扫描 Terraform 配置中的安全问题。

## 模块化

- 为基础设施的每个主要组件使用单独的项目；这：
  - 降低复杂性
  - 使配置的管理和维护更加容易
  - 加快 `plan` 和 `apply` 操作
  - 允许组件独立开发和部署
  - 降低意外更改无关资源的风险
- 使用模块来避免配置重复。
  - 使用模块封装相关资源和配置。
  - 使用模块简化复杂配置并提高可读性。
  - 避免模块之间的循环依赖。
  - 避免不必要的抽象层级；仅在模块能提供价值时使用。
    - 避免为单个资源使用模块；仅在相关资源组时使用。
    - 避免模块的过度嵌套；保持模块层次结构扁平。
- 使用 `output` 块来暴露基础设施的重要信息。
  - 使用输出提供对其他模块或配置使用者有用的信息。
  - 避免在输出中暴露敏感信息；如果输出包含敏感数据，请标记为 `sensitive = true`。

## 可维护性

- 优先考虑可读性、清晰度和可维护性。
- 使用注释解释复杂配置以及某些设计决策的原因。
- 编写简洁、高效且符合 Terraform 习惯的配置，便于理解。
- 避免使用硬编码值；使用变量进行配置。
  - 在适当的情况下为变量设置默认值。
- 使用数据源来检索现有资源的信息，而不是要求手动配置。
  - 这样可以降低错误风险，确保配置始终是最新的，并允许配置适应不同环境。
  - 避免在同一个配置中创建资源时使用数据源；应使用输出代替。
  - 避免或删除不必要的数据源；它们会减慢 `plan` 和 `apply` 操作。
- 使用 `locals` 来存储多次使用的值以确保一致性。

## 风格与格式

- 遵循 Terraform 的最佳实践来命名和组织资源。
  - 为资源、变量和输出使用描述性的名称。
  - 在所有配置中使用一致的命名约定。
- 遵循 **Terraform 风格指南** 进行格式化。
  - 使用一致的缩进（每级 2 个空格）。
- 在同一文件中将相关资源分组。
  - 为资源组使用一致的命名约定（例如：`providers.tf`、`variables.tf`、`network.tf`、`ecs.tf`、`mariadb.tf`）。
- 将 `depends_on` 块放在资源定义的最开始处，以明确依赖关系。
  - 仅在必要时使用 `depends_on` 以避免循环依赖。
- 将 `for_each` 和 `count` 块放在资源定义的开头处，以阐明资源的实例化逻辑。
  - 对于集合使用 `for_each`，对于数字迭代使用 `count`。
  - 如果存在 `depends_on` 块，则将其放在这些块之后。
- 将 `lifecycle` 块放在资源定义的末尾。
- 在每个文件中按字母顺序排列提供者、变量、数据源、资源和输出，以便更轻松地导航。
- 在块内将相关属性分组。
  - 将必需属性放在可选属性之前，并相应注释每个部分。
  - 使用空行分隔属性部分以提高可读性。
  - 在每个部分内按字母顺序排列属性以便更轻松地导航。
- 使用空行分隔配置中的逻辑部分。
- 使用 `terraform fmt` 自动格式化您的配置。
- 使用 `terraform validate` 检查语法错误并确保配置有效。
- 使用 `tflint` 检查样式违规并确保配置遵循最佳实践。
  - 定期运行 `tflint` 以在开发过程中尽早发现样式问题。

## 文档

- 始终为变量和输出包含 `description` 和 `type` 属性。
  - 使用清晰简洁的描述来解释每个变量和输出的目的。
  - 为变量使用适当的类型（例如：`string`、`number`、`bool`、`list`、`map`）。
- 在适当的情况下使用注释来记录 Terraform 配置。
  - 使用注释解释资源和变量的目的。
  - 使用注释解释复杂配置或决策。
  - 避免冗余注释；注释应增加价值和清晰度。
- 在每个项目中包含 `README.md` 文件以提供项目概述及其结构。
  - 包含设置和使用配置的说明。
- 使用 `terraform-docs` 自动生成配置文档。

## 测试

- 编写测试以验证 Terraform 配置的功能。
  - 使用 `.tftest.hcl` 扩展名用于测试文件。
  - 编写测试以覆盖正向和反向场景。
  - 确保测试是幂等的，可以多次运行而不会产生副作用。