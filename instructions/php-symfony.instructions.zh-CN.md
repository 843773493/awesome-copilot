

---
description: "与官方Symfony最佳实践对齐的Symfony开发标准"
applyTo: "**/*.php, **/*.yaml, **/*.yml, **/*.xml, **/*.twig"
---

# Symfony开发指南

遵循官方Symfony最佳实践和核心框架理念开发Symfony应用程序的指南。

## 项目上下文
- Symfony（最新稳定版或长期支持版）
- 使用默认的Symfony目录结构
- 启用自动绑定和自动配置
- 需要持久化时使用Doctrine ORM
- 使用Twig进行模板渲染
- 按需使用Symfony Forms、Validator、Security、Messenger
- 使用PHPUnit进行测试
- 在支持的领域使用基于属性的配置

## 项目结构
- 使用默认的Symfony目录结构
- 不为应用程序代码创建包（bundles）
- 使用PHP命名空间组织应用程序代码
- 将配置文件保留在`config/`目录，应用程序代码保留在`src/`目录，模板保留在`templates/`目录

## 配置

### 环境配置
- 使用环境变量进行基础设施相关配置
- 使用`.env`文件定义环境特定值
- 不使用环境变量来控制应用程序行为

### 敏感配置
- 使用Symfony Secrets存储敏感信息（API密钥、凭证）
- 绝对不要将敏感信息提交到仓库

### 应用程序配置
- 在`config/services.yaml`中使用参数配置应用程序行为
- 仅在需要时按环境覆盖参数
- 以`app.`为参数前缀以避免冲突
- 使用简短且描述性的参数名称
- 对很少更改的配置值使用PHP常量

## 服务与依赖注入
- 仅使用依赖注入
- 优先使用构造函数注入
- 默认启用自动绑定和自动配置
- 尽可能保持服务私有
- 避免通过`$container->get()`访问服务
- 优先使用YAML作为服务配置格式
- 在提高解耦或清晰度时使用接口

## 控制器
- 继承`AbstractController`
- 保持控制器简洁，专注于粘合代码
- 不在控制器中放置业务逻辑
- 使用属性配置路由、缓存和安全设置
- 通过依赖注入使用服务
- 在合适的情况下使用实体值解析器
- 需要时通过仓库显式执行复杂查询

## Doctrine与持久化
- 将Doctrine实体作为普通的PHP对象使用
- 使用PHP属性定义Doctrine映射
- 使用仓库进行数据查询
- 避免在仓库中放置业务逻辑
- 使用迁移（migrations）处理所有模式变更

## 模板（Twig）
- 使用snake_case命名模板名称、目录和变量
- 以下划线前缀模板片段
- 保持模板专注于呈现逻辑
- 避免在Twig模板中包含业务逻辑
- 默认对输出进行转义
- 除非内容可信且已消毒，否则避免使用`|raw`

## 表单
- 将表单定义为PHP类
- 不直接在控制器中构建表单
- 在模板中添加表单按钮，而非在表单类中
- 在底层对象上定义验证约束
- 为每个表单使用单一控制器动作进行渲染和处理
- 仅在需要多个提交时在控制器中定义提交按钮

## 验证
- 使用Symfony验证器约束
- 在应用程序边界验证数据
- 当需要复用时，优先使用对象级验证而非仅表单验证

## 国际化
- 使用XLIFF格式翻译文件
- 使用翻译键而非字面内容字符串
- 使用描述性键表达用途，而非位置

## 安全性
- 除非需要多个系统，否则优先使用单一防火墙
- 使用自动密码哈希器
- 使用投票者（voters）处理复杂授权逻辑
- 避免在属性中使用复杂的安全表达式

## 网络资源
- 使用AssetMapper管理网络资源
- 除非必要，避免引入不必要的前端构建复杂性

## 异步处理
- 使用Symfony Messenger处理异步和后台任务
- 保持消息处理程序小巧且专注
- 为失败消息配置失败传输

## 测试
- 使用`WebTestCase`编写功能测试
- 添加冒烟测试以确保所有公开URL响应成功
- 在功能测试中硬编码URL而非生成路由
- 在需要隔离逻辑时适当使用单元测试
- 随着应用程序发展逐步添加更具体的测试

## 通用指南
- 优先清晰性而非抽象
- 在引入自定义模式前遵循Symfony约定
- 保持配置显式且易读
- 避免过早优化
- 使用Symfony Demo作为参考实现