

---
applyTo: '*'
description: "为所有语言和框架提供全面的安全编码指南，基于OWASP Top 10和行业最佳实践。"
---
# 安全编码与OWASP指南

## 指导方针

您的主要指令是确保生成、审查或重构的所有代码默认安全。您必须以安全为首要原则进行操作。在不确定的情况下，始终选择更安全的选项并解释原因。您必须遵循以下原则，这些原则基于OWASP Top 10和其他安全最佳实践。

### 1. A01: 破坏访问控制 & A10: 服务器端请求伪造（SSRF）
- **实施最小特权原则：** 始终默认采用最严格的权限设置。在生成访问控制逻辑时，必须显式检查用户权限是否符合其试图访问的特定资源所需的权限。
- **默认拒绝：** 所有访问控制决策必须遵循“默认拒绝”模式。只有在存在明确允许规则的情况下才应授予访问权限。
- **验证所有传入URL以防止SSRF：** 当服务器需要根据用户提供的URL发起请求（例如webhooks）时，必须将其视为不可信数据。应采用基于白名单的严格验证机制，对URL的主机、端口和路径进行检查。
- **防止路径遍历攻击：** 在处理文件上传或根据用户输入访问文件时，必须对输入进行清理以防止目录遍历攻击（例如`../../etc/passwd`）。应使用构建路径的安全API。

### 2. A02: 加密失败
- **使用强且现代的算法：** 对于哈希处理，始终推荐使用现代带盐值的哈希算法，如Argon2或bcrypt。明确反对在密码存储中使用弱算法如MD5或SHA-1。
- **保护传输中的数据：** 在生成网络请求代码时，默认使用HTTPS。
- **保护静态数据：** 在建议存储敏感数据（如PII、令牌等）的代码时，推荐使用强且标准的加密算法（如AES-256）进行加密。
- **安全的密钥管理：** 绝不要硬编码密钥（API密钥、密码、连接字符串）。生成的代码应从环境变量或密钥管理服务（如HashiCorp Vault、AWS Secrets Manager）中读取密钥。包含清晰的占位符和注释。
  ```javascript
  // 好：从环境变量或密钥存储中加载
  const apiKey = process.env.API_KEY; 
  // 请确保在您的环境中安全配置API_KEY。
  ```
  ```python
  # 坏：硬编码的密钥
  api_key = "sk_this_is_a_very_bad_idea_12345" 
  ```

### 3. A03: 注入漏洞
- **不要使用原始SQL查询：** 在数据库交互中，必须使用参数化查询（预编译语句）。绝不要生成使用字符串拼接或格式化从用户输入构建查询的代码。
- **清理命令行输入：** 在执行操作系统命令时，使用内置函数处理参数转义，防止shell注入（例如Python中的`shlex`）。
- **防止跨站脚本攻击（XSS）：** 当生成前端代码以显示用户控制的数据时，必须使用上下文感知的输出编码。优先使用默认将数据视为文本的方法（如`.textContent`）而非解析HTML的方法（如`.innerHTML`）。如果必须使用`innerHTML`，建议首先使用类似DOMPurify的库对HTML进行清理。

### 4. A05: 安全配置错误 & A06: 漏洞组件
- **默认安全配置：** 推荐在生产环境中禁用详细错误信息和调试功能。
- **设置安全头信息：** 对于Web应用，建议添加必要的安全头信息，如`Content-Security-Policy`（CSP）、`Strict-Transport-Security`（HSTS）和`X-Content-Type-Options`。
- **使用最新依赖项：** 当被要求添加新库时，建议使用最新的稳定版本。提醒用户运行漏洞扫描工具如`npm audit`、`pip-audit`或Snyk，以检查项目依赖项中的已知漏洞。

### 5. A07: 身份验证与认证失败
- **安全会话管理：** 用户登录时，生成新的会话标识符以防止会话固定。确保会话Cookie配置了`HttpOnly`、`Secure`和`SameSite=Strict`属性。
- **防止暴力破解：** 在认证和密码重置流程中，建议在多次失败尝试后实施速率限制和账户锁定机制。

### 6. A08: 软件与数据完整性失败
- **防止不安全的反序列化：** 警告不要在未进行适当验证的情况下反序列化来自不可信来源的数据。如果必须进行反序列化，建议使用攻击性较低的格式（如Python中使用JSON而非Pickle）并实施严格的类型检查。

## 通用指南
- **明确说明安全措施：** 当您建议一段代码以缓解安全风险时，必须明确说明您正在保护什么（例如：“此处使用参数化查询以防止SQL注入。”）。
- **在代码审查中进行安全教育：** 当您在代码审查中发现安全漏洞时，不仅要提供修正后的代码，还必须解释原始模式所涉及的风险。