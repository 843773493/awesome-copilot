name: Auto Translate Documentation

on:
  schedule:
    - cron: '0 1 * * *'  # 每天 01:00 UTC 运行
  workflow_dispatch:      # 允许手动触发

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv openai httpx

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for markdown file changes
        id: check-changes
        run: |
          # 获取所有非zh-CN.md结尾的md文件
          echo "Scanning all markdown files and comparing commits..."

          # 获取当前commit和上一个commit之间的差异（所有目录）
          CHANGED_FILES=$(git diff HEAD~1 HEAD --name-only 2>/dev/null | grep '\.md$' | grep -v '\.zh-CN\.md$' || echo "")

          # 获取所有目录的非zh-CN.md md文件
          ALL_MD_FILES=$(find . -name '*.md' -type f | sed 's|^./||' | grep -v '\.zh-CN\.md$' | sort)

          FILES_TO_CHECK=""

          if [ -n "$CHANGED_FILES" ]; then
            # 对于变化的文件，都需要翻译
            FILES_TO_CHECK="$(echo "$CHANGED_FILES" | sort | uniq)"
            echo "Found changed markdown files:"
            echo "$FILES_TO_CHECK"
          fi

          # 检查所有md文件，看是否需要翻译（当对应的.zh-CN.md不存在或过期时）
          echo ""
          echo "Checking for missing or outdated translations..."

          for file in $ALL_MD_FILES; do
            zh_file="${file%.*}.zh-CN.md"

            if [ ! -f "$zh_file" ]; then
              # zh-CN.md文件不存在
              if ! echo "$FILES_TO_CHECK" | grep -q "^$file$"; then
                echo "Missing translation: $file"
                FILES_TO_CHECK="$FILES_TO_CHECK $file"
              fi
            else
              # 检查修改时间，如果原文件比翻译文件更新
              if [ "$file" -nt "$zh_file" ]; then
                if ! echo "$FILES_TO_CHECK" | grep -q "^$file$"; then
                  echo "Outdated translation: $file (source newer than $zh_file)"
                  FILES_TO_CHECK="$FILES_TO_CHECK $file"
                fi
              fi
            fi
          done

          # 整理结果
          FILES_TO_CHECK=$(echo "$FILES_TO_CHECK" | tr ' ' '\n' | sort | uniq | tr '\n' ' ' | xargs)

          if [ -n "$FILES_TO_CHECK" ]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "$FILES_TO_CHECK" | tr ' ' '\n' > changed_files.txt
            echo ""
            echo "Final list of files to translate:"
            cat changed_files.txt
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No markdown files need translation"
          fi
        continue-on-error: true

      - name: Get list of markdown files to translate
        if: steps.check-changes.outputs.has-changes == 'true'
        id: get-files
        run: |
          # 获取根目录所有需要翻译的 .md 文件
          FILES_TO_TRANSLATE=""
          for file in $(cat changed_files.txt); do
            if [ -f "$file" ] && [[ "$file" != *".zh-CN.md"* ]]; then
              FILES_TO_TRANSLATE="$FILES_TO_TRANSLATE $file"
            fi
          done
          echo "files=$FILES_TO_TRANSLATE" >> $GITHUB_OUTPUT
          echo "Files to translate: $FILES_TO_TRANSLATE"

      - name: Run translation
        if: steps.check-changes.outputs.has-changes == 'true'
        env:
          DEFAULT_API_KEY: ${{ secrets.DEFAULT_API_KEY }}
        run: |
          if [ -z "${{ steps.get-files.outputs.files }}" ]; then
            echo "No files to translate"
            exit 0
          fi

          echo "Starting translation..."
          python scripts/translate.py ${{ steps.get-files.outputs.files }}

          if [ $? -eq 0 ]; then
            echo "Translation completed successfully"
          else
            echo "Translation failed"
            exit 1
          fi

      - name: Check for translated files
        if: steps.check-changes.outputs.has-changes == 'true'
        id: check-translated
        run: |
          TRANSLATED_FILES=""
          for file in ${{ steps.get-files.outputs.files }}; do
            filename="${file%.*}"
            translated_file="${filename}.zh-CN.md"
            if [ -f "$translated_file" ]; then
              TRANSLATED_FILES="$TRANSLATED_FILES $translated_file"
            fi
          done

          if [ -z "$TRANSLATED_FILES" ]; then
            echo "No translated files generated"
            echo "has-translated=false" >> $GITHUB_OUTPUT
          else
            echo "has-translated=true" >> $GITHUB_OUTPUT
            echo "translated-files=$TRANSLATED_FILES" >> $GITHUB_OUTPUT
            echo "Translated files: $TRANSLATED_FILES"
          fi

      - name: Create Pull Request
        if: steps.check-translated.outputs.has-translated == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: auto-translate documentation'
          committer: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          title: 'chore: auto-translate documentation files'
          body: |
            ## Auto-Translation

            This PR automatically translates the following English markdown files to Chinese:

            ${{ steps.check-translated.outputs.translated-files }}

            **Translation Details:**
            - Source files: English markdown files (all directories)
            - Target files: `.zh-CN.md` versions
            - Translator: SiliconFlow API (Qwen/Qwen3-8B model)
            - Temperature: 0.3 (for consistency)

            Please review the translations and merge if they are correct.

            ---
            *Generated by [Auto Translate Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          branch: auto-translate-${{ github.run_id }}
          delete-branch: true
          labels: |
            documentation
            translation
            automated

      - name: Auto merge translation PR
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            console.log(`Auto-merging PR #${prNumber}`);

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_message: 'chore: auto-merge translation PR'
              });
              console.log(`✅ PR #${prNumber} merged successfully`);
            } catch (error) {
              console.error(`Failed to merge PR: ${error.message}`);
              throw error;
            }

      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.check-changes.outputs.has-changes }}" = "true" ]; then
            if [ "${{ steps.check-translated.outputs.has-translated }}" = "true" ]; then
              echo "✅ Translation completed and PR created"
              echo "PR branch: auto-translate-${{ github.run_id }}"
            else
              echo "⚠️ No translation files generated"
            fi
          else
            echo "ℹ️ No markdown file changes detected"
          fi
